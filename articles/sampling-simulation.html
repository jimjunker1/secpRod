<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulating the sampling of populations • secpRod</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulating the sampling of populations">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">secpRod</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.101</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/model-testing.html">Testing models of secondary production: simple to advanced</a></li>
    <li><a class="dropdown-item" href="../articles/sampling-simulation.html">Simulating the sampling of populations</a></li>
    <li><a class="dropdown-item" href="../articles/simple-example.html">A few simple examples</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jimjunker1/secpRod/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="sampling-simulation_files/kePrint-0.0.1/kePrint.js"></script><link href="sampling-simulation_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulating the sampling of populations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jimjunker1/secpRod/blob/main/vignettes/articles/sampling-simulation.Rmd" class="external-link"><code>vignettes/articles/sampling-simulation.Rmd</code></a></small>
      <div class="d-none name"><code>sampling-simulation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="purpose">Purpose<a class="anchor" aria-label="anchor" href="#purpose"></a>
</h2>
<p>This document outlines the process for simulating the sampling of
populations for developing and testing models of secondary production.
These processes were used to simulate data for the examples used in the
model tutorials.</p>
</div>
<div class="section level2">
<h2 id="simulation-process">Simulation process<a class="anchor" aria-label="anchor" href="#simulation-process"></a>
</h2>
<p>The data generation process for each data set is based on a simulated
grid based on a number of parameters that control the sampling area,
distribution of individuals, growth and mortality parameters of the
populations, etc. (Table 1).</p>
<table class="table  lightable-classic" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; margin-left: auto; margin-right: auto;'>
<thead><tr>
<th style="text-align:left;">
Parameters
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
grid_size
</td>
<td style="text-align:left;">
The grid dimension of the ‘x’ and ‘y’ direction. Total grid cells is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>n</mi><mn>2</mn></msup><annotation encoding="application/x-tex">n^2</annotation></semantics></math>
</td>
</tr>
<tr>
<td style="text-align:left;">
mu_N_init
</td>
<td style="text-align:left;">
The mean initial density of the grid cells. Values are randomly drawn
from a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><msub><mi>u</mi><mrow><mi>N</mi><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mrow><mi>N</mi><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(mu_{Ninit}, sigma_{Ninit})</annotation></semantics></math>
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_N_init
</td>
<td style="text-align:left;">
The standard deviation of initial density of grid cells. Values are
randomly drawn from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><msub><mi>u</mi><mrow><mi>N</mi><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mrow><mi>N</mi><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(mu_{Ninit}, sigma_{Ninit})</annotation></semantics></math>
</td>
</tr>
<tr>
<td style="text-align:left;">
initial_mass
</td>
<td style="text-align:left;">
The initial mass of all individuals.
</td>
</tr>
<tr>
<td style="text-align:left;">
mu_ln
</td>
<td style="text-align:left;">
The mean asymptotic mass of von Bertalanffy growth. Values for each
individual are randomly draws from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><msub><mi>u</mi><mrow><mi>l</mi><mi>n</mi></mrow></msub><mo>,</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mrow><mi>l</mi><mi>n</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Lognormal(mu_{ln}, sigma_{ln})</annotation></semantics></math>.
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_ln
</td>
<td style="text-align:left;">
The standard deviation of asymptotic mass of von Bertalanffy growth.
Values for each individual are randomly draws from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><msub><mi>u</mi><mrow><mi>l</mi><mi>n</mi></mrow></msub><mo>,</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mrow><mi>l</mi><mi>n</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Lognormal(mu_{ln}, sigma_{ln})</annotation></semantics></math>.
</td>
</tr>
<tr>
<td style="text-align:left;">
mu_z
</td>
<td style="text-align:left;">
The mean mortality rate for a negative exponential model. Values for
each cell are randomly drawn from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><msub><mi>u</mi><mi>z</mi></msub><mo>,</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mi>z</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(mu_{z}, sigma_{z})</annotation></semantics></math>.
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_z
</td>
<td style="text-align:left;">
The standard devation in mortality rate for a negative exponential
model. Values for each cell are randomly drawn from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><msub><mi>u</mi><mi>z</mi></msub><mo>,</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mi>z</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(mu_{z}, sigma_{z})</annotation></semantics></math>.
</td>
</tr>
<tr>
<td style="text-align:left;">
cpi_start
</td>
<td style="text-align:left;">
The lower end of the cohort production interval. This is used to modify
the growth coefficient,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>,
in von Bertalanffy growth. Values for each individual are drawn
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>n</mi><mi>i</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mi>p</mi><msub><mi>i</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>,</mo><mi>c</mi><mi>p</mi><msub><mi>i</mi><mrow><mi>e</mi><mi>n</mi><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Uniform(cpi_{start}, cpi_{end})</annotation></semantics></math>.
</td>
</tr>
<tr>
<td style="text-align:left;">
cpi_end
</td>
<td style="text-align:left;">
The upper end of the cohort production interval.This is used to modify
the growth coefficient,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>,
in von Bertalanffy growth. Values for each individual are drawn
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>n</mi><mi>i</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mi>p</mi><msub><mi>i</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>,</mo><mi>c</mi><mi>p</mi><msub><mi>i</mi><mrow><mi>e</mi><mi>n</mi><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Uniform(cpi_{start}, cpi_{end})</annotation></semantics></math>.
</td>
</tr>
<tr>
<td style="text-align:left;">
days
</td>
<td style="text-align:left;">
The number of days to simulate.
</td>
</tr>
<tr>
<td style="text-align:left;">
sample_interval
</td>
<td style="text-align:left;">
The interval in days between sampling events.
</td>
</tr>
<tr>
<td style="text-align:left;">
sample_start
</td>
<td style="text-align:left;">
The start date (1:days) for the first sampling event.
</td>
</tr>
<tr>
<td style="text-align:left;">
sample_end
</td>
<td style="text-align:left;">
The end date (sample_start:days) for the last sampling event.
</td>
</tr>
<tr>
<td style="text-align:left;">
S
</td>
<td style="text-align:left;">
The number of sample replicates to take at each sampling event. Samples
are chosen without replacement within a sampling event.
</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="single-cohort">Single cohort<a class="anchor" aria-label="anchor" href="#single-cohort"></a>
</h3>
<p>We first simulate a single cohort from the following parameters. The
individuals all have the same initial mass. Each individual grows based
on a von Bertalanffy growth model with a randomly drawn asymptotic mass,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mrow><mi>i</mi><mi>n</mi><mi>f</mi></mrow></msub><annotation encoding="application/x-tex">M_{inf}</annotation></semantics></math>,
and the growth coefficient,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>,
is calculated by a randomly drawn lifespan (CPI) determined by
user-defined inputs. Once an individual reaches
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mrow><mi>i</mi><mi>n</mi><mi>f</mi></mrow></msub><annotation encoding="application/x-tex">M_{inf}</annotation></semantics></math>
it transitions to an ‘adult’ and is no longer counted in samples.
Mortality is governed in each grid cell by a randomly draw death rate,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>z</mi><annotation encoding="application/x-tex">z</annotation></semantics></math>,
from a negative exponential model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parameters</span></span>
<span><span class="va">grid_size</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">mu_N_init</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">sigma_N_init</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">initial_mass</span> <span class="op">&lt;-</span> <span class="fl">0.0006</span></span>
<span><span class="va">mu_ln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">5</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co"># mean of ~5 mg in Normal(mu, sigma)</span></span>
<span><span class="va">sigma_ln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.5</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">#sd of ~0.5mg Normal(mu, sigma)</span></span>
<span><span class="va">mu_z</span> <span class="op">&lt;-</span> <span class="fl">0.04</span></span>
<span><span class="va">sigma_z</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span><span class="va">cpi_start</span> <span class="op">&lt;-</span> <span class="fl">290</span></span>
<span><span class="va">cpi_end</span> <span class="op">&lt;-</span> <span class="fl">310</span></span>
<span><span class="va">days</span> <span class="op">&lt;-</span> <span class="fl">506</span></span>
<span><span class="va">sample_interval</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">sample_start</span> <span class="op">&lt;-</span> <span class="fl">1</span>    </span>
<span><span class="va">sample_end</span> <span class="op">&lt;-</span> <span class="fl">365</span>    </span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fl">10</span>  </span></code></pre></div>
<p>Click below to see the code to simulate a single cohort.</p>
<details><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## not run</span></span>
<span><span class="co"># Function to initialize a cohort</span></span>
<span><span class="va">init_cohort</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">j</span>, <span class="va">start_day</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">N_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_N_init</span>, <span class="va">sigma_N_init</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M_inf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">N_init</span>, meanlog <span class="op">=</span> <span class="va">mu_ln</span>, sdlog <span class="op">=</span> <span class="va">sigma_ln</span><span class="op">)</span></span>
<span>  <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">M_inf</span> <span class="op">/</span> <span class="va">initial_mass</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N_init</span>, <span class="va">cpi_start</span>, <span class="va">cpi_end</span><span class="op">)</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_z</span>, <span class="va">sigma_z</span><span class="op">)</span></span>
<span>  <span class="fu">tibble</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">i</span>,</span>
<span>    y <span class="op">=</span> <span class="va">j</span>,</span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_init</span>,</span>
<span>    mass <span class="op">=</span> <span class="va">initial_mass</span>,</span>
<span>    M_inf <span class="op">=</span> <span class="va">M_inf</span>,</span>
<span>    k <span class="op">=</span> <span class="va">k</span>,</span>
<span>    alive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    adult <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    z <span class="op">=</span> <span class="va">z</span>,</span>
<span>    cohort_start <span class="op">=</span> <span class="va">start_day</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Initialize first cohort on day 1</span></span>
<span><span class="va">grid_population</span> <span class="op">&lt;-</span> <span class="fu">map2_dfr</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, each <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, times <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="op">~</span><span class="fu">init_cohort</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Daily update function for larval individuals only</span></span>
<span><span class="va">update_day</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pop</span>, <span class="va">current_day</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pop</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">alive</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">adult</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      time_since_start <span class="op">=</span> <span class="va">current_day</span> <span class="op">-</span> <span class="va">cohort_start</span>,</span>
<span>      alive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">z</span>,</span>
<span>      mass <span class="op">=</span> <span class="va">M_inf</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">k</span> <span class="op">*</span> <span class="va">time_since_start</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      adult <span class="op">=</span> <span class="va">mass</span> <span class="op">&gt;=</span> <span class="va">M_inf</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">alive</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">adult</span><span class="op">)</span>  <span class="co"># remove those who died or became adult</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run simulation with second cohort added at day 366</span></span>
<span><span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="va">days</span><span class="op">)</span></span>
<span><span class="va">simulation</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grid_population</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1312</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">d</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">days</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">updated_pop</span> <span class="op">&lt;-</span> <span class="fu">update_day</span><span class="op">(</span><span class="va">simulation</span><span class="op">[[</span><span class="va">d</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">d</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">d</span> <span class="op">==</span> <span class="fl">366</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">new_cohort</span> <span class="op">&lt;-</span> <span class="fu">map2_dfr</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, each <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, times <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="op">~</span><span class="fu">init_cohort</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span>, <span class="fl">366</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">updated_pop</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">updated_pop</span>, <span class="va">new_cohort</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">simulation</span><span class="op">[[</span><span class="va">d</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">updated_pop</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine for sampling</span></span>
<span><span class="va">all_days</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">simulation</span>, .id <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sampling protocol (larvae only)</span></span>
<span><span class="va">sampling_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sampled_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">sample_start</span>, <span class="va">sample_end</span>, by <span class="op">=</span> <span class="va">sample_interval</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">all_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sampled_cells</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">prev_sampled</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">sampled_cells</span><span class="op">)</span></span>
<span>    <span class="va">available_cells</span> <span class="op">&lt;-</span> <span class="fu">anti_join</span><span class="op">(</span><span class="va">all_cells</span>, <span class="va">prev_sampled</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">available_cells</span> <span class="op">&lt;-</span> <span class="va">all_cells</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sampled</span> <span class="op">&lt;-</span> <span class="va">available_cells</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">sample_n</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">S</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">available_cells</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sampled_cells</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sampled_cells</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sampled</span></span>
<span></span>
<span>  <span class="va">sampled_data</span> <span class="op">&lt;-</span> <span class="va">all_days</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">day</span> <span class="op">==</span> <span class="va">t</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">semi_join</span><span class="op">(</span><span class="va">sampled</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span></span>
<span>      larval_density <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      mass_distribution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span>,</span>
<span>      .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>day <span class="op">=</span> <span class="va">t</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sampling_results</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sampling_results</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sampled_data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Final output</span></span>
<span><span class="va">daily_sampling</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">sampling_results</span><span class="op">)</span></span></code></pre></div>
</details><div class="section level4">
<h4 id="load-summarise-and-visualize-the-simulated-sampling-data">Load, summarise, and visualize the simulated sampling data<a class="anchor" aria-label="anchor" href="#load-summarise-and-visualize-the-simulated-sampling-data"></a>
</h4>
<p><img src="sampling-simulation_files/figure-html/load-single-sim-data-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="a-split-cohort">A split cohort<a class="anchor" aria-label="anchor" href="#a-split-cohort"></a>
</h3>
<p>This example explore the options to calculate production of a
univoltine population when sampling starts in the middle of a cohort and
ends by sampling a different cohort. This event may not be ideal, but is
very common. We operate under the assumption that the life-history
characteristics and environment, generally, are similar among cohorts.
This may or may not be an acceptable assumption depending on the
specific conditions.</p>
<p>To see the code to produce the simulated data set click below</p>
<details><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spatial growth and mortality simulation in R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/" class="external-link">ggdist</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parameters</span></span>
<span><span class="va">grid_size</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">mu_N_init</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">sigma_N_init</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">initial_mass</span> <span class="op">&lt;-</span> <span class="fl">0.0006</span></span>
<span><span class="va">mu_ln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">5</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sigma_ln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.5</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu_z</span> <span class="op">&lt;-</span> <span class="fl">0.04</span></span>
<span><span class="va">sigma_z</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span><span class="va">cpi_start</span> <span class="op">&lt;-</span> <span class="fl">290</span></span>
<span><span class="va">cpi_end</span> <span class="op">&lt;-</span> <span class="fl">310</span></span>
<span><span class="va">days</span> <span class="op">&lt;-</span> <span class="fl">506</span></span>
<span><span class="va">sample_interval</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">sample_start</span> <span class="op">&lt;-</span> <span class="fl">101</span>    <span class="co"># adjustable start day</span></span>
<span><span class="va">sample_end</span> <span class="op">&lt;-</span> <span class="fl">465</span>    <span class="co"># adjustable end day</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fl">10</span>  <span class="co"># number of cells to sample per event</span></span>
<span></span>
<span><span class="co"># Function to initialize a cohort</span></span>
<span><span class="va">init_cohort</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">j</span>, <span class="va">start_day</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">N_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_N_init</span>, <span class="va">sigma_N_init</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M_inf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">N_init</span>, meanlog <span class="op">=</span> <span class="va">mu_ln</span>, sdlog <span class="op">=</span> <span class="va">sigma_ln</span><span class="op">)</span></span>
<span>  <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">M_inf</span> <span class="op">/</span> <span class="va">initial_mass</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N_init</span>, <span class="va">cpi_start</span>, <span class="va">cpi_end</span><span class="op">)</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_z</span>, <span class="va">sigma_z</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">i</span>,</span>
<span>    y <span class="op">=</span> <span class="va">j</span>,</span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_init</span>,</span>
<span>    mass <span class="op">=</span> <span class="va">initial_mass</span>,</span>
<span>    M_inf <span class="op">=</span> <span class="va">M_inf</span>,</span>
<span>    k <span class="op">=</span> <span class="va">k</span>,</span>
<span>    alive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    adult <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    z <span class="op">=</span> <span class="va">z</span>,</span>
<span>    cohort_start <span class="op">=</span> <span class="va">start_day</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Initialize first cohort on day 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1312</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid_population</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, each <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, times <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="op">~</span><span class="fu">init_cohort</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Daily update function for larval individuals only</span></span>
<span><span class="va">update_day</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pop</span>, <span class="va">current_day</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pop</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">alive</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">adult</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      time_since_start <span class="op">=</span> <span class="va">current_day</span> <span class="op">-</span> <span class="va">cohort_start</span>,</span>
<span>      alive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">z</span>,</span>
<span>      mass <span class="op">=</span> <span class="va">M_inf</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">k</span> <span class="op">*</span> <span class="va">time_since_start</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      adult <span class="op">=</span> <span class="va">mass</span> <span class="op">&gt;=</span> <span class="va">M_inf</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">alive</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">adult</span><span class="op">)</span>  <span class="co"># remove those who died or became adult</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run simulation with second cohort added at day 366</span></span>
<span><span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="va">days</span><span class="op">)</span></span>
<span><span class="va">simulation</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grid_population</span></span>
<span></span>
<span><span class="co">#set seed to reproduce</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">d</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">days</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">updated_pop</span> <span class="op">&lt;-</span> <span class="fu">update_day</span><span class="op">(</span><span class="va">simulation</span><span class="op">[[</span><span class="va">d</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">d</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">d</span> <span class="op">==</span> <span class="fl">366</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">new_cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, each <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, times <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span>, <span class="op">~</span><span class="fu">init_cohort</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span>, <span class="fl">366</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">updated_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">updated_pop</span>, <span class="va">new_cohort</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">simulation</span><span class="op">[[</span><span class="va">d</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">updated_pop</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine for sampling</span></span>
<span><span class="va">all_days</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">simulation</span>, .id <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sampling protocol (larvae only)</span></span>
<span><span class="va">sampling_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sampled_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">sample_start</span>, <span class="va">sample_end</span>, by <span class="op">=</span> <span class="va">sample_interval</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">all_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">grid_size</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sampled_cells</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">prev_sampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">sampled_cells</span><span class="op">)</span></span>
<span>    <span class="va">available_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join</a></span><span class="op">(</span><span class="va">all_cells</span>, <span class="va">prev_sampled</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">available_cells</span> <span class="op">&lt;-</span> <span class="va">all_cells</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sampled</span> <span class="op">&lt;-</span> <span class="va">available_cells</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">S</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">available_cells</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sampled_cells</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sampled_cells</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sampled</span></span>
<span></span>
<span>  <span class="va">sampled_data</span> <span class="op">&lt;-</span> <span class="va">all_days</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">day</span> <span class="op">==</span> <span class="va">t</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">semi_join</a></span><span class="op">(</span><span class="va">sampled</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      larvalDensity <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      massDistribution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span>,</span>
<span>      .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>day <span class="op">=</span> <span class="va">t</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sampling_results</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sampling_results</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sampled_data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Final output</span></span>
<span><span class="va">daily_sampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">sampling_results</span><span class="op">)</span></span></code></pre></div>
</details><div class="section level4">
<h4 id="load-summarise-and-visualize-the-simulated-sampling-data-1">Load, summarise, and visualize the simulated sampling data<a class="anchor" aria-label="anchor" href="#load-summarise-and-visualize-the-simulated-sampling-data-1"></a>
</h4>
<p><img src="sampling-simulation_files/figure-html/load-split-sim-data-1.png" width="700"></p>
<pre><code><span><span class="co">#&gt; tibble [6,666 × 4] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ dateID   : num [1:6666] 101 101 101 101 101 101 101 101 101 101 ...</span></span>
<span><span class="co">#&gt;  $ repID    : int [1:6666] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ n_m2     : int [1:6666] 229 229 229 229 229 229 229 229 229 229 ...</span></span>
<span><span class="co">#&gt;  $ massValue: num [1:6666] 5.02 4.83 4.83 4.8 5.91 ...</span></span>
<span><span class="co">#&gt; [1] "tbl_df"     "tbl"        "data.frame"</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt;   dateID repID  n_m2 massValue</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    101     1   229      5.02</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    101     1   229      4.83</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    101     1   229      4.83</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>    101     1   229      4.80</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>    101     1   229      5.91</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>    101     1   229      5.53</span></span>
<span><span class="co">#&gt; [1] "agg"</span></span>
<span><span class="co">#&gt; [1] "cohorts"</span></span>
<span><span class="co">#&gt; [1] "dfOrdered"</span></span>
<span><span class="co">#&gt; [1] "optim"</span></span>
<span><span class="co">#&gt; [1] "fit out"</span></span>
<span><span class="co">#&gt; [1] "t0"</span></span>
<span><span class="co">#&gt; [1] "raw_age"</span></span>
<span><span class="co">#&gt; [1] "t0"</span></span>
<span><span class="co">#&gt; [1] "raw_age"</span></span>
<span><span class="co">#&gt; [1] "t0"</span></span>
<span><span class="co">#&gt; [1] "raw_age"</span></span>
<span><span class="co">#&gt; Error in 1/D: non-numeric argument to binary operator</span></span>
<span><span class="co">#&gt; No traceback available</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="remapping-a-split-cohort-to-a-single-analysis">Remapping a split cohort to a single analysis<a class="anchor" aria-label="anchor" href="#remapping-a-split-cohort-to-a-single-analysis"></a>
</h4>
<p>In order to perform a full cohort analysis on a cohort that is split
in time, we can ‘remap’ the two cohorts into a new timescale that
follows a consistent cohort progression. We can then calculate
production through regular cohort methods. If we need to extract
time-specific values, we can simply map the estimates back to the
original time scale.</p>
<p>We developed a quick algorithm to automate the determination of the
beginning and ends of a <em>non-overlapping</em> cohort.</p>
<p>This function reorders the sampling events to follow a continuous
growth progression. This allows for the determination of model-based
estimates of cohort production and associated growth statistics and also
keeps the information to re-map the production outputs to the original
sampling times.</p>
<!-- ```{r plot-remap, fig.height=5, fig.width=5, dpi=300, fig.align='center'} -->
<!-- # remappedCohort -->
<!-- #  -->
<!-- # # Model-averaged fit -->
<!-- # p1 = plot_cohort_fit(remappedCohort, models = "ensemble") -->
<!-- #  -->
<!-- # # Specific model fit -->
<!-- # p2 = plot_cohort_fit(remappedCohort, models = "vbg") -->
<!-- # p3 = plot_cohort_fit(remappedCohort, models = "gompertz", labelPoints = FALSE) -->
<!-- # p4 = plot_cohort_fit(remappedCohort, models = "logistic") -->
<!-- #  -->
<!-- # gridExtra::grid.arrange(p1,p2,p3,p4, ncol = 2, nrow = 2) -->
<!-- ``` -->
</div>
</div>
</div>
<div class="section level2">
<h2 id="spared-words">Spare(d) words<a class="anchor" aria-label="anchor" href="#spared-words"></a>
</h2>
<!-- ```{r old reconstruct} -->
<!-- fit_with_offset <- function(df_ordered, offset, models_to_fit = c("vonbert", "gompertz"), t_start = 5) { -->
<!--   stopifnot("cohort" %in% names(df_ordered)) -->
<!--   youngest_dates <- df_ordered %>% dplyr::filter(cohort == min(cohort)) %>% arrange(dateID) -->
<!--   delta_young <- diff(youngest_dates$dateID) -->
<!--   young_pseudotime <- c(0, cumsum(delta_young)) -->
<!--   oldest_dates <- df_ordered %>% dplyr::filter(cohort == max(cohort)) %>% arrange(dateID) -->
<!--   delta_old <- diff(oldest_dates$dateID) -->
<!--   start_old <- tail(young_pseudotime, 1) + delta_old[1]  # gap continuation -->
<!--   old_pseudotime <- c(start_old, start_old + cumsum(delta_old[-1])) -->
<!--   df_pseudo <- bind_rows( -->
<!--     dplyr::mutate(youngest_dates, pseudo_day = young_pseudotime), -->
<!--     dplyr::mutate(oldest_dates, pseudo_day = old_pseudotime) -->
<!--   ) %>% arrange(pseudo_day) -->
<!--   t_all <- df_pseudo$pseudo_day -->
<!--   W_all <- df_pseudo$mean_mass -->
<!--   fits <- list() -->
<!--   aiccs <- c() -->
<!--   if ("vonbert" %in% models_to_fit) { -->
<!--     m <- tryCatch(nls(W_all ~ Winf * (1 - exp(-k * (t_all - t0))), -->
<!--                       start = list(Winf = max(W_all), k = 0.01, t0 = t_start), -->
<!--                       control = nls.control(maxiter = 500)), -->
<!--                   error = function(e) NULL) -->
<!--     if (!is.null(m)) { -->
<!--       fits$vonbert <- m -->
<!--       aiccs["vonbert"] <- AIC(m) + 2 * 3^2 / (length(t_all) - 3 - 1) -->
<!--     } -->
<!--   } -->
<!--   if ("gompertz" %in% models_to_fit) { -->
<!--     m <- tryCatch(nls(W_all ~ Winf * exp(-exp(-k * (t_all - t0))), -->
<!--                       start = list(Winf = max(W_all), k = 0.01, t0 = t_start), -->
<!--                       control = nls.control(maxiter = 500)), -->
<!--                   error = function(e) NULL) -->
<!--     if (!is.null(m)) { -->
<!--       fits$gompertz <- m -->
<!--       aiccs["gompertz"] <- AIC(m) + 2 * 3^2 / (length(t_all) - 3 - 1) -->
<!--     } -->
<!--   } -->
<!--   return(list(fits = fits, aiccs = aiccs, df_pseudo = df_pseudo)) -->
<!-- } -->
<!-- reconstruct_cohort_pseudotime <- function(df, -->
<!--                                                        time_col = "dateID", -->
<!--                                                        mass_col = "massValue", -->
<!--                                                        mass_drop_thresh = 0.6, -->
<!--                                                        t_start = 5, -->
<!--                                                        models_to_fit = c("vonbert", "gompertz"), -->
<!--                                                        offset_bounds = c(10, 150), -->
<!--                                                        fallback_grid = TRUE) { -->
<!--    # Step 1: Sort cohorts by minimum size -->
<!--   # Step 1a: Aggregate replicate-level masses to daily means -->
<!--   agg <- df %>% -->
<!--     group_by(.data[[time_col]]) %>% -->
<!--     summarise(mean_mass = mean(.data[[mass_col]], na.rm = TRUE), .groups = "drop") %>% -->
<!--     arrange(.data[[time_col]]) -->
<!--   t <- agg[[time_col]] -->
<!--   W <- agg$mean_mass -->
<!--   # Step 2a: Detect split cohort via drop in mean mass -->
<!--   dM <- lead(W) / W -->
<!--   drop_idx <- which(dM < mass_drop_thresh)[1] -->
<!--   if (is.na(drop_idx)) drop_idx <- floor(length(t) / 2)  # fallback if no sharp drop -->
<!--   cohort1 <- agg[1:drop_idx, ] -->
<!--   cohort2 <- agg[(drop_idx + 1):length(t), ] -->
<!--   # Step 3a: Reorder cohorts so smallest mass cohort comes first -->
<!--   if (min(cohort1$mean_mass, na.rm = TRUE) > min(cohort2$mean_mass, na.rm = TRUE)) { -->
<!--     tmp <- cohort1 -->
<!--     cohort1 <- cohort2 -->
<!--     cohort2 <- tmp -->
<!--   } -->
<!--   cohort1$cohort <- 1 -->
<!--   cohort2$cohort <- 2 -->
<!--   df_ordered <- bind_rows(cohort1, cohort2) %>% arrange(cohort, .data[[time_col]]) -->
<!--   cohort_min <- df_ordered %>% -->
<!--     group_by(cohort) %>% -->
<!--     summarise(min_mass = min(mean_mass), .groups = "drop") %>% -->
<!--     arrange(min_mass) %>% -->
<!--     pull(cohort) -->
<!--   # df_ordered$cohort <- factor(df_ordered$cohort, levels = cohort_min) -->
<!--   df_ordered <- df_ordered %>% arrange(cohort, dateID) -->
<!--   obj_fn <- function(offset) { -->
<!--     out <- fit_with_offset(df_ordered, offset, models_to_fit, t_start) -->
<!--     if (length(out$aiccs) == 0) return(Inf) -->
<!--     sum(unlist(out$aiccs)) -->
<!--   } -->
<!--   # debugonce(fit_with_offset) -->
<!--   offset_opt <- tryCatch({ -->
<!--     optim(par = 50, fn = obj_fn, method = "L-BFGS-B", -->
<!--           lower = offset_bounds[1], upper = offset_bounds[2])$par -->
<!--   }, error = function(e) { -->
<!--     if (fallback_grid) { -->
<!--       grid <- seq(offset_bounds[1], offset_bounds[2], by = 1) -->
<!--       grid_scores <- sapply(grid, obj_fn) -->
<!--       grid[which.min(grid_scores)] -->
<!--     } else stop("Optimization failed and grid fallback is off.") -->
<!--   }) -->
<!--   fit_out <- fit_with_offset(df_ordered, offset_opt, models_to_fit, t_start) -->
<!--   fits <- fit_out$fits -->
<!--   df_pseudo <- fit_out$df_pseudo -->
<!--   t <- df_pseudo$pseudo_day -->
<!--   W <- df_pseudo$mean_mass -->
<!--   W_cap <- pmin(W, max(W) * 0.999) -->
<!--   cohort_ages <- list() -->
<!--   weights <- c() -->
<!--   for (model_name in names(fits)) { -->
<!--     p <- coef(fits[[model_name]]) -->
<!--     raw_age <- switch(model_name, -->
<!--       vonbert = -log(1 - W_cap / p["Winf"]) / p["k"], -->
<!--       gompertz = p["t0"] - log(-log(W_cap / p["Winf"])) / p["k"] -->
<!--     ) -->
<!--     # Align so first pseudotime = abs(t0) -->
<!--     cohort_ages[[model_name]] <- raw_age - min(raw_age) + abs(p["t0"]) -->
<!--     weights[model_name] <- AIC(fits[[model_name]]) + 2 * 3^2 / (length(t) - 3 - 1) -->
<!--   } -->
<!--   rel_weights <- exp(-0.5 * (weights - min(weights))) -->
<!--   rel_weights <- rel_weights / sum(rel_weights) -->
<!--   pseudo_time <- as.vector(do.call(cbind, cohort_ages) %*% rel_weights) -->
<!--   pseudo_time <- round(pseudo_time) -->
<!--   df_remap <- df_pseudo %>% -->
<!--     dplyr::mutate(pseudotime = pseudo_time) %>% -->
<!--     arrange(pseudotime) -->
<!--   return(list( -->
<!--     df_remap = df_remap, -->
<!--     offset = offset_opt, -->
<!--     weights = rel_weights, -->
<!--     fits = fits -->
<!--   )) -->
<!-- } -->
<!-- debugonce(reconstruct_cohort_pseudotime_restructured) -->
<!-- x = reconstruct_cohort_pseudotime_restructured(df = df) -->
<!-- ``` -->
<!-- ```{r old-reconstruct} -->
<!-- reconstruct_cohort_pseudotime <- function(df, -->
<!--                                           time_col = "dateID", -->
<!--                                           mass_col = "massValue", -->
<!--                                           mass_drop_thresh = 0.6, -->
<!--                                           t_start = 5, -->
<!--                                           models_to_fit = c("vonbert", "gompertz"), -->
<!--                                           use_grid_fallback = TRUE, -->
<!--                                           verbose = TRUE) { -->
<!--   # library(dplyr) -->
<!--   # Step 1: Aggregate replicate-level masses to daily means -->
<!--   agg <- df %>% -->
<!--     group_by(.data[[time_col]]) %>% -->
<!--     summarise(mean_mass = mean(.data[[mass_col]], na.rm = TRUE), .groups = "drop") %>% -->
<!--     arrange(.data[[time_col]]) -->
<!--   t <- agg[[time_col]] -->
<!--   W <- agg$mean_mass -->
<!--   # Step 2: Detect split cohort via drop in mean mass -->
<!--   dM <- lead(W) / W -->
<!--   drop_idx <- which(dM < mass_drop_thresh)[1] -->
<!--   if (is.na(drop_idx)) drop_idx <- floor(length(t) / 2)  # fallback if no sharp drop -->
<!--   cohort1 <- agg[1:drop_idx, ] -->
<!--   cohort2 <- agg[(drop_idx + 1):length(t), ] -->
<!--   # Step 3: Reorder cohorts so smallest mass cohort comes first -->
<!--   if (min(cohort1$mean_mass, na.rm = TRUE) > min(cohort2$mean_mass, na.rm = TRUE)) { -->
<!--     tmp <- cohort1 -->
<!--     cohort1 <- cohort2 -->
<!--     cohort2 <- tmp -->
<!--   } -->
<!--   cohort1$cohort <- 1 -->
<!--   cohort2$cohort <- 2 -->
<!--   df_ordered <- bind_rows(cohort1, cohort2) %>% arrange(cohort, .data[[time_col]]) -->
<!--   # Step 4: Estimate time offset between cohorts -->
<!--   try_fit_growth_model <- function(formula, start, data) { -->
<!--     tryCatch(nls(formula, start = start, data = data, -->
<!--                  control = nls.control(maxiter = 500)), error = function(e) NULL) -->
<!--   } -->
<!--   fit_with_offset <- function(offset) { -->
<!--     t_all <- c(df_ordered[[time_col]][df_ordered$cohort == 1], -->
<!--                df_ordered[[time_col]][df_ordered$cohort == 2] + offset) -->
<!--     W_all <- df_ordered$mean_mass -->
<!--     df_tmp <- data.frame(t = t_all, W = W_all) -->
<!--     fits <- list() -->
<!--     aiccs <- c() -->
<!--     if ("vonbert" %in% models_to_fit) { -->
<!--       m <- try_fit_growth_model( -->
<!--         W ~ Winf * (1 - exp(-k * (t - t0))), -->
<!--         start = list(Winf = max(W), k = 0.01, t0 = t_start), -->
<!--         data = df_tmp -->
<!--       ) -->
<!--       if (!is.null(m)) { -->
<!--         fits$vonbert <- m -->
<!--         aiccs["vonbert"] <- AIC(m) + 2 * 3^2 / (length(t_all) - 3 - 1) -->
<!--       } -->
<!--     } -->
<!--     if ("gompertz" %in% models_to_fit) { -->
<!--       m <- try_fit_growth_model( -->
<!--         W ~ Winf * exp(-exp(-k * (t - t0))), -->
<!--         start = list(Winf = max(W), k = 0.01, t0 = t_start), -->
<!--         data = df_tmp -->
<!--       ) -->
<!--       if (!is.null(m)) { -->
<!--         fits$gompertz <- m -->
<!--         aiccs["gompertz"] <- AIC(m) + 2 * 3^2 / (length(t_all) - 3 - 1) -->
<!--       } -->
<!--     } -->
<!--     list(fits = fits, aiccs = aiccs) -->
<!--   } -->
<!-- debugonce(fit_with_offset) -->
<!--   # Step 5: Optimize offset to minimize AICc across models -->
<!--   obj_fn <- function(offset) { -->
<!--     out <- fit_with_offset(offset) -->
<!--     sum(unlist(out$aiccs)) -->
<!--   } -->
<!--   offset_opt <- optim(par = 30, fn = obj_fn, method = "L-BFGS-B", lower = 1, upper = 150)$par -->
<!--   # if(is.null(tryCatch({, error = function(e) { -->
<!--   #   if (use_grid_fallback) { -->
<!--   #     grid <- seq(5, 150, by = 1) -->
<!--   #     grid_scores <- sapply(grid, obj_fn) -->
<!--   #     grid[which.min(grid_scores)] -->
<!--   #   } else { -->
<!--   #     stop("Optimization failed and grid fallback is disabled.") -->
<!--   #   } -->
<!--   # }) -->
<!--   # Step 6: Reconstruct time vector with best offset -->
<!--   df_ordered <- df_ordered %>% -->
<!--     dplyr::mutate( -->
<!--       true_time = ifelse(cohort == 1, -->
<!--                          !!sym(time_col), -->
<!--                          !!sym(time_col) + offset_opt) -->
<!--     ) -->
<!--   # Step 7: Fit models at optimal offset and invert -->
<!--   best_fits <- fit_with_offset(offset_opt)$fits -->
<!--   t_true <- df_ordered$true_time -->
<!--   W_true <- df_ordered$mean_mass -->
<!--   W_cap <- pmin(W_true, max(W_true) * 0.999) -->
<!--   cohort_ages <- list() -->
<!--   weights <- c() -->
<!--   for (model_name in names(best_fits)) { -->
<!--     m <- best_fits[[model_name]] -->
<!--     p <- coef(m) -->
<!--     age <- switch(model_name, -->
<!--                   vonbert = -log(1 - W_cap / p["Winf"]) / p["k"], -->
<!--                   gompertz = p["t0"] - log(-log(W_cap / p["Winf"])) / p["k"]) -->
<!--     cohort_ages[[model_name]] <- age -->
<!--     weights[model_name] <- AIC(m) + 2 * 3^2 / (length(t_true) - 3 - 1) -->
<!--   } -->
<!--   # Normalize AICc weights -->
<!--   rel_weights <- exp(-0.5 * (weights - min(weights))) -->
<!--   rel_weights <- rel_weights / sum(rel_weights) -->
<!--   # Ensemble pseudotime -->
<!--   cohort_age_mat <- do.call(cbind, cohort_ages) -->
<!--   pseudo_time <- as.vector(cohort_age_mat %*% rel_weights) -->
<!--   pseudo_time_shifted <- round(pseudo_time - min(pseudo_time) + t_start) -->
<!--   df_final <- df_ordered %>% -->
<!--     dplyr::mutate(pseudotime = pseudo_time_shifted) %>% -->
<!--     arrange(pseudotime) -->
<!--   if (verbose) { -->
<!--     cat("Offset estimated:", round(offset_opt), "days\n") -->
<!--     cat("Model weights:\n") -->
<!--     print(round(rel_weights, 3)) -->
<!--   } -->
<!--   return(list( -->
<!--     df_remap = df_final %>% select(!!sym(time_col), mean_mass, pseudotime, true_time), -->
<!--     offset = offset_opt, -->
<!--     weights = rel_weights, -->
<!--     fits = best_fits -->
<!--   )) -->
<!-- } -->
<!-- debugonce(reconstruct_cohort_pseudotime) -->
<!-- remap_out <- reconstruct_cohort_pseudotime(df) -->
<!-- plot_pseudotime_remap <- function(remap_result, -->
<!--                                   show_model_fits = TRUE, -->
<!--                                   show_legend = TRUE) { -->
<!--   df <- remap_result$df_remap -->
<!--   fits <- remap_result$fits -->
<!--   weights <- remap_result$weights -->
<!--   p <- ggplot(df, aes(x = pseudotime, y = mean_mass)) + -->
<!--     geom_point(size = 2) + -->
<!--     labs( -->
<!--       x = "Pseudotime (days)", -->
<!--       y = "Mean mass (mg)", -->
<!--       title = "Remapped cohort trajectory with fitted growth models" -->
<!--     ) + -->
<!--     theme_minimal() -->
<!--   # Add model fits -->
<!--   if (show_model_fits && length(fits) > 0) { -->
<!--     x_pred <- seq(min(df$pseudotime), max(df$pseudotime), length.out = 200) -->
<!--     for (model_name in names(fits)) { -->
<!--       params <- coef(fits[[model_name]]) -->
<!--       y_pred <- switch(model_name, -->
<!--                        vonbert = params["Winf"] * (1 - exp(-params["k"] * (x_pred))), -->
<!--                        gompertz = params["Winf"] * exp(-exp(-params["k"] * (x_pred - params["t0"])))) -->
<!--       fit_df <- data.frame(x = x_pred, y = y_pred, model = model_name) -->
<!--       p <- p + geom_line(data = fit_df, aes(x = x, y = y, color = model), -->
<!--                          size = 1, alpha = weights[model_name]) -->
<!--     } -->
<!--   } -->
<!--   if (!show_legend) { -->
<!--     p <- p + theme(legend.position = "none") -->
<!--   } -->
<!--   return(p) -->
<!-- } -->
<!-- plot_pseudotime_remap(remap_out) -->
<!-- ``` -->
<!-- ```{r spare(d)-words} -->
<!-- df = df %>% -->
<!--   summarise( -->
<!--     massValue = mean(massValue, na.rm = TRUE), -->
<!--     .by = 'dateID' -->
<!--   ) -->
<!-- remap_cohort_by_growth <- function(df, -->
<!--                                    time_col = "dateID", -->
<!--                                    mass_col = "massValue", -->
<!--                                    models_to_fit = c("vonbert", "gompertz"), -->
<!--                                    pseudo_start = 1, -->
<!--                                    verbose = TRUE) { -->
<!--   df <- df %>% arrange(.data[[time_col]]) -->
<!--   t <- df[[time_col]] -->
<!--   W <- df[[mass_col]] -->
<!--   # Helper to fit models -->
<!--   fit_growth_model <- function(formula, start, data) { -->
<!--     tryCatch( -->
<!--       nls(formula, start = start, data = data, control = nls.control(maxiter = 200)), -->
<!--       error = function(e) NULL -->
<!--     ) -->
<!--   } -->
<!--   # Fit von Bertalanffy -->
<!--   vb_fit <- NULL -->
<!--   if ("vonbert" %in% models_to_fit) { -->
<!--     vb_fit <- fit_growth_model( -->
<!--       W ~ Winf * (1 - exp(-k * (t - t0))), -->
<!--       start = list(Winf = max(W), k = 0.01, t0 = min(t)), -->
<!--       data = data.frame(t = t, W = W) -->
<!--     ) -->
<!--   } -->
<!--   # Fit Gompertz -->
<!--   gomp_fit <- NULL -->
<!--   if ("gompertz" %in% models_to_fit) { -->
<!--     gomp_fit <- fit_growth_model( -->
<!--       W ~ Winf * exp(-exp(-k * (t - t0))), -->
<!--       start = list(Winf = max(W), k = 0.01, t0 = mean(t)), -->
<!--       data = data.frame(t = t, W = W) -->
<!--     ) -->
<!--   } -->
<!--   # Compute AICc -->
<!--   models <- list() -->
<!--   aiccs <- c() -->
<!--   if (!is.null(vb_fit)) { -->
<!--     models$vonbert <- vb_fit -->
<!--     aiccs["vonbert"] <- AIC(vb_fit) + 2 * 3^2 / (length(W) - 3 - 1) -->
<!--   } -->
<!--   if (!is.null(gomp_fit)) { -->
<!--     models$gompertz <- gomp_fit -->
<!--     aiccs["gompertz"] <- AIC(gomp_fit) + 2 * 3^2 / (length(W) - 3 - 1) -->
<!--   } -->
<!--   if (length(models) == 0) stop("No growth model fit successfully") -->
<!--   # Compute model weights -->
<!--   weights <- exp(-0.5 * (aiccs - min(aiccs))) -->
<!--   weights <- weights / sum(weights) -->
<!--   # Invert to cohort age -->
<!--   W_sanitized <- pmin(W, max(W) * 0.999)  # avoid log(0) -->
<!--   cohort_age_list <- list() -->
<!--   if (!is.null(vb_fit)) { -->
<!--     p <- coef(vb_fit) -->
<!--     cohort_age_list$vonbert <- -log(1 - W_sanitized / p["Winf"]) / p["k"] -->
<!--   } -->
<!--   if (!is.null(gomp_fit)) { -->
<!--     p <- coef(gomp_fit) -->
<!--     cohort_age_list$gompertz <- p["t0"] - log(-log(W_sanitized / p["Winf"])) / p["k"] -->
<!--   } -->
<!--   # Weighted average cohort age -->
<!--   cohort_age_matrix <- do.call(cbind, cohort_age_list) -->
<!--   weighted_age <- cohort_age_matrix %*% matrix(weights[names(cohort_age_list)], ncol = 1) -->
<!--   pseudo_day <- round(weighted_age - min(weighted_age, na.rm = TRUE) + pseudo_start) -->
<!--   df_remap <- df %>% -->
<!--     dplyr::mutate( -->
<!--       cohort_age = as.vector(weighted_age), -->
<!--       pseudo_day = pseudo_day -->
<!--     ) %>% -->
<!--     arrange(pseudo_day) -->
<!--   if (verbose) { -->
<!--     cat("Model weights:\n") -->
<!--     print(round(weights, 3)) -->
<!--   } -->
<!--   return(list( -->
<!--     df_remap = df_remap, -->
<!--     models = models, -->
<!--     weights = weights -->
<!--   )) -->
<!-- } -->
<!-- debugonce(remap_cohort_by_growth) -->
<!-- result <- remap_cohort_by_growth(df) -->
<!-- estimate_vbgf_age <- function(m, Winf, k, t0) { -->
<!--   -log(1 - pmin(m / Winf, 0.999)) / k -->
<!-- } -->
<!-- estimate_gompertz_age <- function(m, Winf, k, t0) { -->
<!--   t0 - log(-log(pmin(m / Winf, 0.999))) / k -->
<!-- } -->
<!-- fit_growth_model <- function(formula, start, data) { -->
<!--   tryCatch( -->
<!--     nls(formula, start = start, data = data, control = nls.control(maxiter = 200)), -->
<!--     error = function(e) NULL -->
<!--   ) -->
<!-- } -->
<!-- multi_model_remap <- function(df, time_col = "dateID", mass_col = "massValue", pseudo_start = 1) { -->
<!--   df <- df %>% arrange(.data[[time_col]]) -->
<!--   t <- df[[time_col]] -->
<!--   W <- df[[mass_col]] -->
<!--   ## Fit von Bertalanffy -->
<!--   vb_fit <- fit_growth_model( -->
<!--     W ~ Winf * (1 - exp(-k * (t - t0))), -->
<!--     start = list(Winf = max(W), k = 0.01, t0 = min(t)), -->
<!--     data = data.frame(t = t, W = W) -->
<!--   ) -->
<!--   ## Fit Gompertz -->
<!--   gomp_fit <- fit_growth_model( -->
<!--     W ~ Winf * exp(-exp(-k * (t - t0))), -->
<!--     start = list(Winf = max(W), k = 0.01, t0 = mean(t)), -->
<!--     data = data.frame(t = t, W = W) -->
<!--   ) -->
<!--   # Model weights via AICc -->
<!--   models <- list(vbgf = vb_fit, gompertz = gomp_fit) -->
<!--   aiccs <- sapply(models, function(m) if (!is.null(m)) AIC(m) + 2 * 3^2 / (length(W) - 3 - 1) else Inf) -->
<!--   weights <- exp(-0.5 * (aiccs - min(aiccs))) / sum(exp(-0.5 * (aiccs - min(aiccs)))) -->
<!--   # Invert to cohort age -->
<!--   age_vbgf <- if (!is.null(vb_fit)) estimate_vbgf_age(W, coef(vb_fit)["Winf"], coef(vb_fit)["k"], coef(vb_fit)["t0"]) else NA -->
<!--   age_gomp <- if (!is.null(gomp_fit)) estimate_gompertz_age(W, coef(gomp_fit)["Winf"], coef(gomp_fit)["k"], coef(gomp_fit)["t0"]) else NA -->
<!--   # Weighted average age -->
<!--   cohort_age <- rowMeans(cbind( -->
<!--     if (!is.null(age_vbgf)) weights["vbgf"] * age_vbgf else NA, -->
<!--     if (!is.null(age_gomp)){weights["gompertz"] * age_gomp} else{NA} -->
<!--   ), na.rm = TRUE) -->
<!--   df_remap <- df %>% -->
<!--     dplyr::mutate( -->
<!--       cohort_age = cohort_age, -->
<!--       pseudo_day = round(cohort_age - min(cohort_age, na.rm = TRUE) + pseudo_start) -->
<!--     ) %>% -->
<!--     arrange(pseudo_day) -->
<!--   return(list( -->
<!--     df_remap = df_remap, -->
<!--     models = models, -->
<!--     weights = weights -->
<!--   )) -->
<!-- } -->
<!-- x = multi_model_remap(df) -->
<!-- detect_cohort_bounds_growth_driven <- function(taxaSampleList, -->
<!--                                                massValue = "massValue", -->
<!--                                                abunValue = "n_m2", -->
<!--                                                massDropThresh = 0.90,  # Mass must not drop >10% -->
<!--                                                densityJumpThresh = 2, -->
<!--                                                timeGapThresh = 70) { -->
<!--   df <- taxaSampleList %>% -->
<!--     arrange(dateID) %>% -->
<!--     summarise(across(all_of(c(massValue, abunValue)), mean), .by = "dateID") %>% -->
<!--     dplyr::mutate( -->
<!--       mass_ratio = lead(!!sym(massValue)) / !!sym(massValue), -->
<!--       density_ratio = lead(!!sym(abunValue)) / !!sym(abunValue), -->
<!--       dt = lead(dateID) - dateID -->
<!--     ) -->
<!--   break_indices <- which( -->
<!--     (df$mass_ratio < massDropThresh) |           # large drop in mass → new cohort -->
<!--     (df$density_ratio > densityJumpThresh) |     # large increase in density → recruitment -->
<!--     (df$dt > timeGapThresh)                      # large gap → likely cohort break -->
<!--   ) -->
<!--   # Define cohort bounds -->
<!--   cohort_bounds <- list() -->
<!--   start_idx <- 1 -->
<!--   for (i in seq_along(break_indices)) { -->
<!--     end_idx <- break_indices[i] -->
<!--     cohort_bounds[[i]] <- c(df$dateID[start_idx], df$dateID[end_idx]) -->
<!--     start_idx <- end_idx + 1 -->
<!--   } -->
<!--   # Final cohort -->
<!--   if (start_idx <= nrow(df)) { -->
<!--     cohort_bounds[[length(cohort_bounds) + 1]] <- c(df$dateID[start_idx], df$dateID[nrow(df)]) -->
<!--   } -->
<!--   return(cohort_bounds) -->
<!-- } -->
<!-- debugonce(detect_cohort_bounds_growth_driven) -->
<!-- bounds <- detect_cohort_bounds_growth_driven( -->
<!--   taxaSampleList = df, -->
<!--   massDropThresh = 0.9, -->
<!--   densityJumpThresh = 2, -->
<!--   timeGapThresh = 70 -->
<!-- ) -->
<!-- # detect_cohort_bounds <- function(taxaSampleList, -->
<!-- #                                  massValue = "massValue", -->
<!-- #                                  abunValue = "n_m2", -->
<!-- #                                  z_thresh = 2.5, -->
<!-- #                                  timeGapThresh = 70) { -->
<!-- #  -->
<!-- #   df <- taxaSampleList %>% -->
<!-- #     arrange(dateID) %>% -->
<!-- #     summarise(across(all_of(c(massValue, abunValue)), mean), .by = "dateID") %>% -->
<!-- #     dplyr::mutate( -->
<!-- #       log_dM = c(NA, diff(log(!!sym(massValue)))), -->
<!-- #       log_dN = c(NA, diff(log(!!sym(abunValue)))), -->
<!-- #       dt = c(NA, diff(dateID)), -->
<!-- #       z_mass = scale(log_dM), -->
<!-- #       z_abun = scale(log_dN) -->
<!-- #     ) -->
<!-- #  -->
<!-- #   # Flag discontinuities using z-scores -->
<!-- #   break_indices <- which( -->
<!-- #     abs(df$z_mass) > z_thresh | -->
<!-- #       abs(df$z_abun) > z_thresh | -->
<!-- #       df$dt > timeGapThresh -->
<!-- #   ) -->
<!-- #  -->
<!-- #   # Define cohort bounds -->
<!-- #   cohort_bounds <- list() -->
<!-- #   start_idx <- 1 -->
<!-- #   for (i in seq_along(break_indices)) { -->
<!-- #     end_idx <- break_indices[i] -->
<!-- #     cohort_bounds[[i]] <- c(df$dateID[start_idx], df$dateID[end_idx]) -->
<!-- #     start_idx <- end_idx + 1 -->
<!-- #   } -->
<!-- #  -->
<!-- #   # Final segment -->
<!-- #   if (start_idx <= nrow(df)) { -->
<!-- #     cohort_bounds[[length(cohort_bounds) + 1]] <- c(df$dateID[start_idx], df$dateID[nrow(df)]) -->
<!-- #   } -->
<!-- #  -->
<!-- #   return(cohort_bounds) -->
<!-- # } -->
<!-- #  -->
<!-- # bounds = detect_cohort_bounds(taxaSampleList = df, z_thresh = 2.5) -->
<!-- # detect_cohort_bounds <- function(taxaSampleList = NULL,  -->
<!-- #                                  massValue = NULL, -->
<!-- #                                  abunValue = 'n_m2', -->
<!-- #                                  massDropThresh = 0.5, -->
<!-- #                                  abunJumpThresh = 2, -->
<!-- #                                  timeGapThresh = NA) { -->
<!-- # ### tests here #### -->
<!-- #    -->
<!-- # ### End tests #### -->
<!-- #    -->
<!-- #   df <- tibble( -->
<!-- #     dateID = taxaSampleList$dateID, -->
<!-- #     massValue = taxaSampleList[[massValue]], -->
<!-- #     abunValue = taxaSampleList[[abunValue]], -->
<!-- #     ) %>% -->
<!-- #     arrange(dateID) %>% -->
<!-- #     summarise(across(c(massValue, abunValue), mean), .by = 'dateID') %>%  -->
<!-- #     dplyr::mutate( -->
<!-- #       dM = lead(massValue) / massValue, -->
<!-- #       dN = lead(abunValue) / abunValue, -->
<!-- #       dt = lead(dateID) - dateID -->
<!-- #     ) -->
<!-- #    -->
<!-- #   # Identify break points -->
<!-- #   break_indices <- which( -->
<!-- #     (df$dM <= (massDropThresh)) | -->
<!-- #       (df$dN > abunJumpThresh) | -->
<!-- #       (df$dt > timeGapThresh) -->
<!-- #   ) -->
<!-- #    -->
<!-- #   # Define cohort bounds -->
<!-- #   cohort_bounds <- list() -->
<!-- #   start_idx <- 1 -->
<!-- #   for (i in seq_along(break_indices)) { -->
<!-- #     end_idx <- break_indices[i] -->
<!-- #     cohort_bounds[[i]] <- c(df$dateID[start_idx], df$dateID[end_idx]) -->
<!-- #     start_idx <- end_idx + 1 -->
<!-- #   } -->
<!-- #    -->
<!-- #   # Final segment -->
<!-- #   if (start_idx <= nrow(df)) { -->
<!-- #     cohort_bounds[[length(break_indices) + 1]] <- c(df$dateID[start_idx], df$dateID[nrow(df)]) -->
<!-- #   } -->
<!-- #    -->
<!-- #   return(cohort_bounds) -->
<!-- # } -->
<!-- #  -->
<!-- # bounds = detect_cohort_bounds(taxaSampleList = df, -->
<!-- #                      massValue = 'massValue', -->
<!-- #                      abunValue = 'n_m2', -->
<!-- #                      massDropThresh = 0.5, -->
<!-- #                      abunJumpThresh = 10, -->
<!-- #                      timeGapThresh = 70) -->
<!-- cohort_remap <- function(time_vec, cohort_bounds) { -->
<!--   remap_time <- numeric(length(time_vec)) -->
<!--   cohort_labels <- numeric(length(time_vec)) -->
<!--   for (i in seq_along(cohort_bounds)) { -->
<!--     bounds <- cohort_bounds[[i]] -->
<!--     in_cohort <- time_vec >= bounds[1] & time_vec <= bounds[2] -->
<!--     # Map to pseudo-time within cohort -->
<!--     remap_time[in_cohort] <- time_vec[in_cohort] - bounds[1] + 1 -->
<!--     cohort_labels[in_cohort] <- i -->
<!--   } -->
<!--   tibble( -->
<!--     dateID = time_vec, -->
<!--     remap_time = remap_time, -->
<!--     cohort = cohort_labels -->
<!--   ) -->
<!-- } -->
<!-- cohortRemap = cohort_remap(unique(df$dateID), bounds) -->
<!-- df = df %>% merge(cohortRemap, by = 'dateID') -->
<!-- summary_stats <- df %>% -->
<!--   group_by(remap_time) %>% -->
<!--   summarise( -->
<!--     massMean = mean(massValue, na.rm = TRUE), -->
<!--     massSD= sd(massValue, na.rm = TRUE), -->
<!--     larvalDensityMean = mean(n_m2), -->
<!--     .groups = "drop" -->
<!--   ) -->
<!-- ggplot(summary_stats, aes(x = remap_time)) + -->
<!--   stat_halfeye(data = df, aes(x = remap_time, y = n_m2), -->
<!--                color = 'green')+ -->
<!--   stat_halfeye(data = df, aes(x = remap_time, y = massValue*100), -->
<!--                color = 'red')+ -->
<!--   geom_path(aes(y = larvalDensityMean), color = 'green') + -->
<!--   geom_path(aes(y = massMean * 100), color = 'red') + -->
<!--   scale_y_continuous( -->
<!--     name = "Larval Density", -->
<!--     sec.axis = sec_axis(~./100, name = "Mean Mass (mg)"), -->
<!--   ) + -->
<!--   theme_minimal() + -->
<!--   labs(title = "Larval Density and Mean Mass over Time", x = "Day")+ -->
<!--   theme(axis.title.y.right = element_text(color = 'red')) -->
<!-- ``` -->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jim Junker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
